{
  "schemaVersion": "v1",
  "name": "Agentic Safe Repair â€“ Login & Session Stabilizer",
  "description": "Safely fix login/session/navigation regressions between Streamlit frontend and FastAPI backend. Minimal, tightly-scoped edits only.",
  "intent": [
    "Stabilize authentication",
    "Fix session persistence and navigation guards",
    "Align backend token response keys with frontend"
  ],
  "guardrails": {
    "allow": [
      "Edit only targeted lines in existing files",
      "Small, local fixes to Streamlit session handling",
      "Small, local fixes to JWT/login logic",
      "Small, local fixes to redirect/navigation conditions",
      "Small, local fixes to backend login/refresh response keys"
    ],
    "deny": [
      "Create files",
      "Delete files",
      "Move or rename files/folders",
      "Introduce new modules or dependencies",
      "Large refactors or architectural changes",
      "Changing unrelated code"
    ],
    "enforcement": "hard"
  },
  "scope": {
    "root": ".",
    "paths": [
      "dashboard/Home.py",
      "dashboard/components/auth_client.py",
      "dashboard/components/auth_utils.py",
      "dashboard/components/session_manager.py",
      "dashboard/pages/1_Analyze_Task.py",
      "dashboard/pages/2_Compliance_Calendar.py",
      "dashboard/pages/3_Audit_Trail.py",
      "dashboard/pages/4_Agent_Insights.py",
      "dashboard/pages/5_Agentic_Analysis.py",
      "dashboard/pages/7_Agentic_Test_Suite.py",
      "dashboard/pages/8_Error_Recovery_Simulator.py",
      "dashboard/pages/9_Agentic_Benchmarks.py",
      "dashboard/pages/10_Deployment_Readiness.py",
      "src/auth/auth_router.py",
      "src/auth/security.py",
      "src/auth/user_manager.py"
    ],
    "fileCreation": "forbidden",
    "fileDeletion": "forbidden"
  },
  "checks": [
    "Frontend: Streamlit sets st.session_state['authenticated'] = True upon successful login",
    "Frontend: Access and refresh tokens stored consistently (keys: 'token', 'refresh')",
    "Frontend: Unified guard uses require_auth()/check_auth() without false positives",
    "Frontend: Navigation uses st.switch_page without loops",
    "Backend: /auth/login returns JSON keys: access_token, refresh_token, token_type=bearer",
    "Backend: /auth/refresh returns the same keys as login",
    "Backend: /auth/me validates Authorization: Bearer <access_token>",
    "No unrelated files modified",
    "No files created or deleted"
  ],
  "repairPlan": [
    "Inspect backend auth endpoints to confirm response payload keys",
    "Inspect Streamlit login handler for token extraction and session flag",
    "Ensure require_auth() guard is used consistently and checks a single flag",
    "Fix any mismatched key names and rerun guard logic",
    "Verify rerun/redirect flow avoids loops and false 'Please login first'"
  ],
  "successCriteria": [
    "Login persists after initial authentication",
    "Protected pages load without 'Please login first' when authenticated",
    "No redirect loops when navigating between pages",
    "Backend and frontend token keys match",
    "Only targeted login/session/navigation lines changed"
  ],
  "runbook": {
    "howToTest": [
      "Start backend (FastAPI) and Streamlit dashboard",
      "Login with demo/demo123",
      "Navigate to pages 1, 2, 3 to confirm access without warnings",
      "Reload the app to ensure session persists or refreshes successfully",
      "Logout, verify access is blocked again"
    ],
    "manualValidationPrompt": "Verify that: login works end to end; navigation works after login; no redirect loop exists; session_state keys are set correctly; backend login response matches frontend expectations; no files were created or deleted; no unrelated files were modified. Print a validation summary."
  }
}

